{"cells":[{"source":"<a href=\"https://www.kaggle.com/code/rputtam/pyspark-explore?scriptVersionId=183885011\" target=\"_blank\"><img align=\"left\" alt=\"Kaggle\" title=\"Open in Kaggle\" src=\"https://kaggle.com/static/images/open-in-kaggle.svg\"></a>","metadata":{},"cell_type":"markdown"},{"cell_type":"markdown","id":"9e126807","metadata":{"papermill":{"duration":0.010239,"end_time":"2024-06-16T23:25:21.545975","exception":false,"start_time":"2024-06-16T23:25:21.535736","status":"completed"},"tags":[]},"source":["## This notebook aims to utilize pyspark and explore various functions for data analysis and manipulation."]},{"cell_type":"markdown","id":"69198622","metadata":{"papermill":{"duration":0.009596,"end_time":"2024-06-16T23:25:21.565684","exception":false,"start_time":"2024-06-16T23:25:21.556088","status":"completed"},"tags":[]},"source":["Resources for pySpark \n","1. https://sparkbyexamples.com/pyspark-tutorial/\n","2. https://github.com/spark-examples/pyspark-examples\n","3. https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/functions.html?hl=en-GB"]},{"cell_type":"markdown","id":"d5dc6d8a","metadata":{"papermill":{"duration":0.009489,"end_time":"2024-06-16T23:25:21.585052","exception":false,"start_time":"2024-06-16T23:25:21.575563","status":"completed"},"tags":[]},"source":["##### There are two types of pyspark rdd operations - transformations and actions\n","* Transformations return rdds\n","* Actions return the result (non-rdds)"]},{"cell_type":"code","execution_count":1,"id":"16db3051","metadata":{"_cell_guid":"b1076dfc-b9ad-4769-8c92-a6c4dae69d19","_uuid":"8f2839f25d086af736a60e9eeb907d3b93b6e0e5","execution":{"iopub.execute_input":"2024-06-16T23:25:21.606875Z","iopub.status.busy":"2024-06-16T23:25:21.606467Z","iopub.status.idle":"2024-06-16T23:25:22.459512Z","shell.execute_reply":"2024-06-16T23:25:22.458459Z"},"papermill":{"duration":0.867009,"end_time":"2024-06-16T23:25:22.462037","exception":false,"start_time":"2024-06-16T23:25:21.595028","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["/kaggle/input/employees-performance-for-hr-analytics/Uncleaned_employees_final_dataset (1).csv\n"]}],"source":["# This Python 3 environment comes with many helpful analytics libraries installed\n","# It is defined by the kaggle/python Docker image: https://github.com/kaggle/docker-python\n","# For example, here's several helpful packages to load\n","\n","import numpy as np # linear algebra\n","import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\n","\n","# Input data files are available in the read-only \"../input/\" directory\n","# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n","\n","import os\n","for dirname, _, filenames in os.walk('/kaggle/input'):\n","    for filename in filenames:\n","        print(os.path.join(dirname, filename))\n","\n","# You can write up to 20GB to the current directory (/kaggle/working/) that gets preserved as output when you create a version using \"Save & Run All\" \n","# You can also write temporary files to /kaggle/temp/, but they won't be saved outside of the current session"]},{"cell_type":"markdown","id":"b571aa70","metadata":{"papermill":{"duration":0.010251,"end_time":"2024-06-16T23:25:22.482444","exception":false,"start_time":"2024-06-16T23:25:22.472193","status":"completed"},"tags":[]},"source":["## Install PySpark"]},{"cell_type":"code","execution_count":2,"id":"c8cef2ba","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:25:22.504488Z","iopub.status.busy":"2024-06-16T23:25:22.503946Z","iopub.status.idle":"2024-06-16T23:26:11.409769Z","shell.execute_reply":"2024-06-16T23:26:11.408729Z"},"papermill":{"duration":48.920076,"end_time":"2024-06-16T23:26:11.412455","exception":false,"start_time":"2024-06-16T23:25:22.492379","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["Collecting pyspark\r\n","  Downloading pyspark-3.5.1.tar.gz (317.0 MB)\r\n","\u001b[2K     \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m317.0/317.0 MB\u001b[0m \u001b[31m4.8 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\r\n","\u001b[?25h  Preparing metadata (setup.py) ... \u001b[?25l-\b \b\\\b \bdone\r\n","\u001b[?25hRequirement already satisfied: py4j==0.10.9.7 in /opt/conda/lib/python3.10/site-packages (from pyspark) (0.10.9.7)\r\n","Building wheels for collected packages: pyspark\r\n","  Building wheel for pyspark (setup.py) ... \u001b[?25l-\b \b\\\b \b|\b \bdone\r\n","\u001b[?25h  Created wheel for pyspark: filename=pyspark-3.5.1-py2.py3-none-any.whl size=317488493 sha256=b44c71b41c598e5788087f3aa2e709fa4946da2b203c3191e9f06c6398589ab5\r\n","  Stored in directory: /root/.cache/pip/wheels/80/1d/60/2c256ed38dddce2fdd93be545214a63e02fbd8d74fb0b7f3a6\r\n","Successfully built pyspark\r\n","Installing collected packages: pyspark\r\n","Successfully installed pyspark-3.5.1\r\n"]}],"source":["# Installing Pyspark\n","!pip install pyspark"]},{"cell_type":"markdown","id":"2f24ff4a","metadata":{"papermill":{"duration":0.016095,"end_time":"2024-06-16T23:26:11.44492","exception":false,"start_time":"2024-06-16T23:26:11.428825","status":"completed"},"tags":[]},"source":["## Create SparkSession"]},{"cell_type":"code","execution_count":3,"id":"a2e2e181","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:11.480524Z","iopub.status.busy":"2024-06-16T23:26:11.479337Z","iopub.status.idle":"2024-06-16T23:26:16.70982Z","shell.execute_reply":"2024-06-16T23:26:16.708543Z"},"papermill":{"duration":5.251071,"end_time":"2024-06-16T23:26:16.71257","exception":false,"start_time":"2024-06-16T23:26:11.461499","status":"completed"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["Setting default log level to \"WARN\".\n","To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).\n","24/06/16 23:26:14 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable\n"]}],"source":["# Importing and creating SparkSession\n","from pyspark.sql import SparkSession\n","spark = SparkSession.builder.appName('explore_pyspark').getOrCreate()"]},{"cell_type":"code","execution_count":4,"id":"1d3e77f7","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:16.749122Z","iopub.status.busy":"2024-06-16T23:26:16.748747Z","iopub.status.idle":"2024-06-16T23:26:16.75424Z","shell.execute_reply":"2024-06-16T23:26:16.753081Z"},"papermill":{"duration":0.027168,"end_time":"2024-06-16T23:26:16.756791","exception":false,"start_time":"2024-06-16T23:26:16.729623","status":"completed"},"tags":[]},"outputs":[],"source":["# Importing necessary packages\n","from pyspark.sql.types import *\n","#from pyspark.sql.functions import *\n","import pyspark.sql.functions as F"]},{"cell_type":"markdown","id":"0ec0886c","metadata":{"papermill":{"duration":0.016542,"end_time":"2024-06-16T23:26:16.789798","exception":false,"start_time":"2024-06-16T23:26:16.773256","status":"completed"},"tags":[]},"source":["## Loading data"]},{"cell_type":"code","execution_count":5,"id":"f6a6436f","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:16.824205Z","iopub.status.busy":"2024-06-16T23:26:16.82342Z","iopub.status.idle":"2024-06-16T23:26:23.169198Z","shell.execute_reply":"2024-06-16T23:26:23.168177Z"},"papermill":{"duration":6.366471,"end_time":"2024-06-16T23:26:23.172409","exception":false,"start_time":"2024-06-16T23:26:16.805938","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["root\n"," |-- employee_id: string (nullable = true)\n"," |-- department: string (nullable = true)\n"," |-- region: string (nullable = true)\n"," |-- education: string (nullable = true)\n"," |-- gender: string (nullable = true)\n"," |-- recruitment_channel: string (nullable = true)\n"," |-- no_of_trainings: string (nullable = true)\n"," |-- age: string (nullable = true)\n"," |-- previous_year_rating: string (nullable = true)\n"," |-- length_of_service: string (nullable = true)\n"," |-- KPIs_met_more_than_80: string (nullable = true)\n"," |-- awards_won: string (nullable = true)\n"," |-- avg_training_score: string (nullable = true)\n","\n"]}],"source":["# Reading the kaggle dataset without inferschema\n","df = spark.read.csv('/kaggle/input/employees-performance-for-hr-analytics/Uncleaned_employees_final_dataset (1).csv',header=True)\n","df.printSchema()"]},{"cell_type":"code","execution_count":6,"id":"8140b046","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:23.21762Z","iopub.status.busy":"2024-06-16T23:26:23.216541Z","iopub.status.idle":"2024-06-16T23:26:24.086146Z","shell.execute_reply":"2024-06-16T23:26:24.084948Z"},"papermill":{"duration":0.89088,"end_time":"2024-06-16T23:26:24.089073","exception":false,"start_time":"2024-06-16T23:26:23.198193","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["root\n"," |-- employee_id: integer (nullable = true)\n"," |-- department: string (nullable = true)\n"," |-- region: string (nullable = true)\n"," |-- education: string (nullable = true)\n"," |-- gender: string (nullable = true)\n"," |-- recruitment_channel: string (nullable = true)\n"," |-- no_of_trainings: integer (nullable = true)\n"," |-- age: integer (nullable = true)\n"," |-- previous_year_rating: integer (nullable = true)\n"," |-- length_of_service: integer (nullable = true)\n"," |-- KPIs_met_more_than_80: integer (nullable = true)\n"," |-- awards_won: integer (nullable = true)\n"," |-- avg_training_score: integer (nullable = true)\n","\n"]}],"source":["# Reading the kaggle dataset with inferschema and checking the data types\n","df = spark.read.csv('/kaggle/input/employees-performance-for-hr-analytics/Uncleaned_employees_final_dataset (1).csv',inferSchema= True,header=True)\n","#inferSchema infers the datatype of field from its values. But it reads the entire data and may have performance issues while reading larger datasets.\n","#The otherway is to predefine the schema using structType that saves time - Optimized approach\n","df.printSchema()"]},{"cell_type":"code","execution_count":7,"id":"a17810f0","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:24.143578Z","iopub.status.busy":"2024-06-16T23:26:24.143081Z","iopub.status.idle":"2024-06-16T23:26:24.152455Z","shell.execute_reply":"2024-06-16T23:26:24.151062Z"},"papermill":{"duration":0.039614,"end_time":"2024-06-16T23:26:24.15524","exception":false,"start_time":"2024-06-16T23:26:24.115626","status":"completed"},"tags":[]},"outputs":[],"source":["#Pre-defining the schmea\n","# Note, all the fields available in the data need to be defined, the size of the structType and dataframe should match\n","\n","sch = StructType([\n","    StructField(\"employee_id\",IntegerType(),True),\n","    StructField(\"department\",StringType(),True),\n","    StructField(\"region\",StringType(),True),\n","    StructField(\"education\",StringType(),True),\n","    StructField(\"gender\",StringType(),True),\n","    StructField(\"recruitment_channel\",StringType(),True),\n","    StructField(\"no_of_trainings\",IntegerType(),True),\n","    StructField(\"age\",IntegerType(),True),\n","    StructField(\"previous_year_rating\",IntegerType(),True),\n","    StructField(\"length_of_service\",IntegerType(),True),\n","    StructField(\"KPIs_met_more_than_80\",IntegerType(),True),\n","    StructField(\"awards_won\",IntegerType(),True),\n","    StructField(\"avg_training_score\",IntegerType(),True)\n","])"]},{"cell_type":"code","execution_count":8,"id":"b4151122","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:24.210297Z","iopub.status.busy":"2024-06-16T23:26:24.209797Z","iopub.status.idle":"2024-06-16T23:26:24.299687Z","shell.execute_reply":"2024-06-16T23:26:24.298024Z"},"papermill":{"duration":0.120056,"end_time":"2024-06-16T23:26:24.302266","exception":false,"start_time":"2024-06-16T23:26:24.18221","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["root\n"," |-- employee_id: integer (nullable = true)\n"," |-- department: string (nullable = true)\n"," |-- region: string (nullable = true)\n"," |-- education: string (nullable = true)\n"," |-- gender: string (nullable = true)\n"," |-- recruitment_channel: string (nullable = true)\n"," |-- no_of_trainings: integer (nullable = true)\n"," |-- age: integer (nullable = true)\n"," |-- previous_year_rating: integer (nullable = true)\n"," |-- length_of_service: integer (nullable = true)\n"," |-- KPIs_met_more_than_80: integer (nullable = true)\n"," |-- awards_won: integer (nullable = true)\n"," |-- avg_training_score: integer (nullable = true)\n","\n"]}],"source":["df3 = spark.read\\\n",".option(\"header\",True) \\\n",".schema(sch) \\\n",".csv('/kaggle/input/employees-performance-for-hr-analytics/Uncleaned_employees_final_dataset (1).csv')\n","\n","df3.printSchema()"]},{"cell_type":"markdown","id":"1885c3bd","metadata":{"papermill":{"duration":0.016751,"end_time":"2024-06-16T23:26:24.335863","exception":false,"start_time":"2024-06-16T23:26:24.319112","status":"completed"},"tags":[]},"source":["## withColumn()"]},{"cell_type":"markdown","id":"ba2f85e9","metadata":{"papermill":{"duration":0.016239,"end_time":"2024-06-16T23:26:24.368536","exception":false,"start_time":"2024-06-16T23:26:24.352297","status":"completed"},"tags":[]},"source":["### .lit()"]},{"cell_type":"code","execution_count":9,"id":"e9772524","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:24.402947Z","iopub.status.busy":"2024-06-16T23:26:24.402592Z","iopub.status.idle":"2024-06-16T23:26:24.803298Z","shell.execute_reply":"2024-06-16T23:26:24.802058Z"},"papermill":{"duration":0.42112,"end_time":"2024-06-16T23:26:24.806046","exception":false,"start_time":"2024-06-16T23:26:24.384926","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+-------+-------+\n","|employee_id|company|country|\n","+-----------+-------+-------+\n","|       8724|    ABC|    USA|\n","|      74430|    ABC|    USA|\n","+-----------+-------+-------+\n","only showing top 2 rows\n","\n"]}],"source":["# Creating new column with constant value\n","df2 = df.withColumn(\"company\",F.lit('ABC'))\\\n","        .withColumn(\"country\", F.lit('USA'))\n","df2.select('employee_id','company','country').show(2)"]},{"cell_type":"code","execution_count":10,"id":"68fbc90a","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:24.858643Z","iopub.status.busy":"2024-06-16T23:26:24.858161Z","iopub.status.idle":"2024-06-16T23:26:24.941434Z","shell.execute_reply":"2024-06-16T23:26:24.94039Z"},"papermill":{"duration":0.113422,"end_time":"2024-06-16T23:26:24.944947","exception":false,"start_time":"2024-06-16T23:26:24.831525","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["root\n"," |-- employee_id: integer (nullable = true)\n"," |-- department: string (nullable = true)\n"," |-- region: string (nullable = true)\n"," |-- education: string (nullable = true)\n"," |-- gender: string (nullable = true)\n"," |-- recruitment_channel: string (nullable = true)\n"," |-- no_of_trainings: integer (nullable = true)\n"," |-- age: integer (nullable = true)\n"," |-- previous_year_rating: integer (nullable = true)\n"," |-- length_of_service: integer (nullable = true)\n"," |-- KPIs_met_more_than_80: integer (nullable = true)\n"," |-- awards_won: integer (nullable = true)\n"," |-- avg_training_score: integer (nullable = true)\n","\n"]}],"source":["# Changing column datatypes of selected fields using withColumn\n","\n","df2 = df.withColumn(\"age\",df.age.cast(IntegerType())) \\\n",".withColumn(\"length_of_service\",df.length_of_service.cast(IntegerType()))\n","df2.printSchema()"]},{"cell_type":"code","execution_count":11,"id":"471be07a","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:24.998878Z","iopub.status.busy":"2024-06-16T23:26:24.998381Z","iopub.status.idle":"2024-06-16T23:26:25.022769Z","shell.execute_reply":"2024-06-16T23:26:25.021743Z"},"papermill":{"duration":0.054403,"end_time":"2024-06-16T23:26:25.025577","exception":false,"start_time":"2024-06-16T23:26:24.971174","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["root\n"," |-- employee_id: integer (nullable = true)\n"," |-- department: string (nullable = true)\n"," |-- region: string (nullable = true)\n"," |-- education: string (nullable = true)\n"," |-- gender: string (nullable = true)\n"," |-- recruitment_channel: string (nullable = true)\n"," |-- no_of_trainings: integer (nullable = true)\n"," |-- age: integer (nullable = true)\n"," |-- previous_year_rating: integer (nullable = true)\n"," |-- length_of_service: integer (nullable = true)\n"," |-- KPIs_met_more_than_80: integer (nullable = true)\n"," |-- awards_won: integer (nullable = true)\n"," |-- avg_training_score: integer (nullable = true)\n","\n"]}],"source":["# Rename column\n","df2 = df2.withColumnsRenamed({'country':'nation','company':'org'})\n","df2.printSchema()"]},{"cell_type":"code","execution_count":12,"id":"6e4e4a56","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:25.078556Z","iopub.status.busy":"2024-06-16T23:26:25.078057Z","iopub.status.idle":"2024-06-16T23:26:25.099875Z","shell.execute_reply":"2024-06-16T23:26:25.098895Z"},"papermill":{"duration":0.051343,"end_time":"2024-06-16T23:26:25.102476","exception":false,"start_time":"2024-06-16T23:26:25.051133","status":"completed"},"tags":[]},"outputs":[{"data":{"text/plain":["['employee_id',\n"," 'department',\n"," 'region',\n"," 'education',\n"," 'gender',\n"," 'recruitment_channel',\n"," 'no_of_trainings',\n"," 'age',\n"," 'previous_year_rating',\n"," 'length_of_service',\n"," 'KPIs_met_more_than_80',\n"," 'awards_won',\n"," 'avg_training_score']"]},"execution_count":12,"metadata":{},"output_type":"execute_result"}],"source":["df2=df2.drop(\"org\",\"nation\")\n","df2.columns"]},{"cell_type":"markdown","id":"fece5bae","metadata":{"papermill":{"duration":0.019199,"end_time":"2024-06-16T23:26:25.14797","exception":false,"start_time":"2024-06-16T23:26:25.128771","status":"completed"},"tags":[]},"source":["## .select()"]},{"cell_type":"code","execution_count":13,"id":"fe63d84f","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:25.183183Z","iopub.status.busy":"2024-06-16T23:26:25.182801Z","iopub.status.idle":"2024-06-16T23:26:25.48841Z","shell.execute_reply":"2024-06-16T23:26:25.487181Z"},"papermill":{"duration":0.327033,"end_time":"2024-06-16T23:26:25.491856","exception":false,"start_time":"2024-06-16T23:26:25.164823","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["<class 'pyspark.sql.dataframe.DataFrame'>\n","+-----------+---+\n","|employee_id|age|\n","+-----------+---+\n","|       8724| 24|\n","|      74430| 31|\n","|      72255| 31|\n","|      38562| 31|\n","|      64486| 30|\n","+-----------+---+\n","only showing top 5 rows\n","\n"]}],"source":["# selecting few fields using select\n","x = df3.select('employee_id','age')\n","print(type(x))\n","x.show(5)"]},{"cell_type":"markdown","id":"6b0b1bf9","metadata":{"papermill":{"duration":0.017092,"end_time":"2024-06-16T23:26:25.605224","exception":false,"start_time":"2024-06-16T23:26:25.588132","status":"completed"},"tags":[]},"source":["## .filter()"]},{"cell_type":"code","execution_count":14,"id":"a8bcfccd","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:25.642041Z","iopub.status.busy":"2024-06-16T23:26:25.641556Z","iopub.status.idle":"2024-06-16T23:26:25.921504Z","shell.execute_reply":"2024-06-16T23:26:25.920303Z"},"papermill":{"duration":0.301879,"end_time":"2024-06-16T23:26:25.92475","exception":false,"start_time":"2024-06-16T23:26:25.622871","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+---+\n","|employee_id|age|\n","+-----------+---+\n","|       8724| 24|\n","|      74430| 31|\n","|      72255| 31|\n","|      38562| 31|\n","|      64486| 30|\n","+-----------+---+\n","only showing top 5 rows\n","\n"]}],"source":["#filter with one condition\n","df3.filter(df3.age > 20).select('employee_id','age').show(5)"]},{"cell_type":"code","execution_count":15,"id":"aa66d5ae","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:25.974823Z","iopub.status.busy":"2024-06-16T23:26:25.974267Z","iopub.status.idle":"2024-06-16T23:26:26.267408Z","shell.execute_reply":"2024-06-16T23:26:26.26556Z"},"papermill":{"duration":0.317896,"end_time":"2024-06-16T23:26:26.270102","exception":false,"start_time":"2024-06-16T23:26:25.952206","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+----------+---+\n","|employee_id|department|age|\n","+-----------+----------+---+\n","|      74430|        HR| 31|\n","|      10761|        HR| 58|\n","|      50038|        HR| 33|\n","|      50380|        HR| 31|\n","+-----------+----------+---+\n","only showing top 4 rows\n","\n"]}],"source":["#Filter with multiple conditions\n","df3.filter( (df3.age >20) & (df3.department == \"HR\") ).select('employee_id',\n","                                                              'department',\n","                                                              'age').show(4)"]},{"cell_type":"code","execution_count":16,"id":"f9d06717","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:26.328163Z","iopub.status.busy":"2024-06-16T23:26:26.32766Z","iopub.status.idle":"2024-06-16T23:26:26.363095Z","shell.execute_reply":"2024-06-16T23:26:26.361843Z"},"papermill":{"duration":0.068477,"end_time":"2024-06-16T23:26:26.366473","exception":false,"start_time":"2024-06-16T23:26:26.297996","status":"completed"},"tags":[]},"outputs":[],"source":["# Finance and age>40 or HR \n","df4 = df3.filter( ( (df3.department == \"Finance\") & (df3.age>40) ) | (df3.department == \"HR\") )\\\n","        .select('employee_id','department','age')"]},{"cell_type":"code","execution_count":17,"id":"d135ba5c","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:26.422651Z","iopub.status.busy":"2024-06-16T23:26:26.422158Z","iopub.status.idle":"2024-06-16T23:26:27.790299Z","shell.execute_reply":"2024-06-16T23:26:27.789236Z"},"papermill":{"duration":1.39979,"end_time":"2024-06-16T23:26:27.793834","exception":false,"start_time":"2024-06-16T23:26:26.394044","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+----------+-----+\n","|department|count|\n","+----------+-----+\n","|        HR|  833|\n","|   Finance|   78|\n","+----------+-----+\n","\n"]}],"source":["df4.groupBy('department')\\\n",".count()\\\n",".show()"]},{"cell_type":"code","execution_count":18,"id":"bc10c096","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:27.844245Z","iopub.status.busy":"2024-06-16T23:26:27.843429Z","iopub.status.idle":"2024-06-16T23:26:28.136882Z","shell.execute_reply":"2024-06-16T23:26:28.135729Z"},"papermill":{"duration":0.317144,"end_time":"2024-06-16T23:26:28.13979","exception":false,"start_time":"2024-06-16T23:26:27.822646","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+----------+---+\n","|employee_id|department|age|\n","+-----------+----------+---+\n","+-----------+----------+---+\n","\n"]}],"source":["df4.filter((df4.department==\"Finance\") & (df4.age<40)).show()"]},{"cell_type":"markdown","id":"aa1afcd8","metadata":{"papermill":{"duration":0.017316,"end_time":"2024-06-16T23:26:28.183385","exception":false,"start_time":"2024-06-16T23:26:28.166069","status":"completed"},"tags":[]},"source":["### Get unique values for categorical fields"]},{"cell_type":"code","execution_count":19,"id":"479d246b","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:28.220789Z","iopub.status.busy":"2024-06-16T23:26:28.220351Z","iopub.status.idle":"2024-06-16T23:26:28.715548Z","shell.execute_reply":"2024-06-16T23:26:28.714251Z"},"papermill":{"duration":0.51824,"end_time":"2024-06-16T23:26:28.719087","exception":false,"start_time":"2024-06-16T23:26:28.200847","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------------+\n","|       department|\n","+-----------------+\n","|               HR|\n","|          Finance|\n","|        Analytics|\n","|            Legal|\n","|Sales & Marketing|\n","|       Technology|\n","|      Procurement|\n","|       Operations|\n","|              R&D|\n","+-----------------+\n","\n"]}],"source":["df3.select('department')\\\n",".distinct().show()"]},{"cell_type":"code","execution_count":20,"id":"6765deb6","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:28.778114Z","iopub.status.busy":"2024-06-16T23:26:28.7776Z","iopub.status.idle":"2024-06-16T23:26:29.223096Z","shell.execute_reply":"2024-06-16T23:26:29.222119Z"},"papermill":{"duration":0.477944,"end_time":"2024-06-16T23:26:29.225653","exception":false,"start_time":"2024-06-16T23:26:28.747709","status":"completed"},"tags":[]},"outputs":[{"data":{"text/plain":["['Finance',\n"," 'Legal',\n"," 'Sales & Marketing',\n"," 'HR',\n"," 'Operations',\n"," 'R&D',\n"," 'Analytics',\n"," 'Technology',\n"," 'Procurement']"]},"execution_count":20,"metadata":{},"output_type":"execute_result"}],"source":["# to get unique values as a list\n","df3.agg(F.collect_set(\"department\")).collect()[0][0]"]},{"cell_type":"code","execution_count":21,"id":"95c0762a","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:29.281513Z","iopub.status.busy":"2024-06-16T23:26:29.280178Z","iopub.status.idle":"2024-06-16T23:26:29.690012Z","shell.execute_reply":"2024-06-16T23:26:29.688409Z"},"papermill":{"duration":0.441229,"end_time":"2024-06-16T23:26:29.693912","exception":false,"start_time":"2024-06-16T23:26:29.252683","status":"completed"},"tags":[]},"outputs":[{"data":{"text/plain":["['other', 'referred', 'sourcing']"]},"execution_count":21,"metadata":{},"output_type":"execute_result"}],"source":["df3.agg(F.collect_set(\"recruitment_channel\")).collect()[0][0]"]},{"cell_type":"code","execution_count":22,"id":"5757bd1d","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:29.748617Z","iopub.status.busy":"2024-06-16T23:26:29.748067Z","iopub.status.idle":"2024-06-16T23:26:30.157817Z","shell.execute_reply":"2024-06-16T23:26:30.15629Z"},"papermill":{"duration":0.440115,"end_time":"2024-06-16T23:26:30.160619","exception":false,"start_time":"2024-06-16T23:26:29.720504","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+----------+\n","|department|\n","+----------+\n","| Analytics|\n","|Technology|\n","|       R&D|\n","+----------+\n","\n"]}],"source":["dept =['R&D','Technology','Analytics']\n","df4=df3.filter(df3.department.isin(dept))\n","df4.select(df4.department).distinct().show()"]},{"cell_type":"code","execution_count":23,"id":"4b095281","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:30.218153Z","iopub.status.busy":"2024-06-16T23:26:30.217692Z","iopub.status.idle":"2024-06-16T23:26:30.225317Z","shell.execute_reply":"2024-06-16T23:26:30.224316Z"},"papermill":{"duration":0.038835,"end_time":"2024-06-16T23:26:30.227516","exception":false,"start_time":"2024-06-16T23:26:30.188681","status":"completed"},"tags":[]},"outputs":[{"data":{"text/plain":["['employee_id',\n"," 'department',\n"," 'region',\n"," 'education',\n"," 'gender',\n"," 'recruitment_channel',\n"," 'no_of_trainings',\n"," 'age',\n"," 'previous_year_rating',\n"," 'length_of_service',\n"," 'KPIs_met_more_than_80',\n"," 'awards_won',\n"," 'avg_training_score']"]},"execution_count":23,"metadata":{},"output_type":"execute_result"}],"source":["df3.columns"]},{"cell_type":"markdown","id":"67ff4da0","metadata":{"papermill":{"duration":0.01816,"end_time":"2024-06-16T23:26:30.264002","exception":false,"start_time":"2024-06-16T23:26:30.245842","status":"completed"},"tags":[]},"source":["## Aggregate functions"]},{"cell_type":"code","execution_count":24,"id":"58463997","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:30.302694Z","iopub.status.busy":"2024-06-16T23:26:30.30228Z","iopub.status.idle":"2024-06-16T23:26:31.117851Z","shell.execute_reply":"2024-06-16T23:26:31.116701Z"},"papermill":{"duration":0.838093,"end_time":"2024-06-16T23:26:31.120726","exception":false,"start_time":"2024-06-16T23:26:30.282633","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------------+----------+------------------+-------+\n","|       department|median_age|avg_training_score|max_los|\n","+-----------------+----------+------------------+-------+\n","|               HR|      32.0| 50.38775510204081|      2|\n","|          Finance|      31.0| 60.32668329177057|      2|\n","|        Analytics|      31.0| 84.56511490866235|      4|\n","|            Legal|      32.0| 59.53313253012048|      2|\n","|Sales & Marketing|      33.0| 50.05661414437523|      3|\n","|       Technology|      33.0| 79.84765802637563|      4|\n","|      Procurement|      34.5| 70.18035714285715|      4|\n","|       Operations|      35.0|60.351589103291715|      4|\n","|              R&D|      32.0| 84.45180722891567|      2|\n","+-----------------+----------+------------------+-------+\n","\n"]}],"source":["df3.groupBy(['department'])\\\n","   .agg(F.round(F.median('age'),2).alias('median_age'),\n","       F.mean('avg_training_score').alias('avg_training_score'),\n","        F.mode('length_of_service').alias('max_los')\n","       ).show()"]},{"cell_type":"code","execution_count":25,"id":"98547cf7","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:31.178265Z","iopub.status.busy":"2024-06-16T23:26:31.17772Z","iopub.status.idle":"2024-06-16T23:26:31.830443Z","shell.execute_reply":"2024-06-16T23:26:31.829442Z"},"papermill":{"duration":0.688829,"end_time":"2024-06-16T23:26:31.837644","exception":false,"start_time":"2024-06-16T23:26:31.148815","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-------------------+----------+------------------+\n","|recruitment_channel|median_age|     trainings_avg|\n","+-------------------+----------+------------------+\n","|              other|      33.0|1.2548456568557071|\n","|           sourcing|      33.0|1.2484691794802014|\n","|           referred|      31.0|1.1766561514195584|\n","+-------------------+----------+------------------+\n","\n"]}],"source":["df3.groupBy(['recruitment_channel'])\\\n","   .agg(F.median('age').alias('median_age'),\n","       F.mean('no_of_trainings').alias('trainings_avg'))\\\n","   .show()"]},{"cell_type":"markdown","id":"666a8e49","metadata":{"papermill":{"duration":0.031018,"end_time":"2024-06-16T23:26:31.898675","exception":false,"start_time":"2024-06-16T23:26:31.867657","status":"completed"},"tags":[]},"source":["## .explode()"]},{"cell_type":"code","execution_count":26,"id":"e345d8d3","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:31.959908Z","iopub.status.busy":"2024-06-16T23:26:31.959437Z","iopub.status.idle":"2024-06-16T23:26:32.183707Z","shell.execute_reply":"2024-06-16T23:26:32.182679Z"},"papermill":{"duration":0.25771,"end_time":"2024-06-16T23:26:32.186579","exception":false,"start_time":"2024-06-16T23:26:31.928869","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+-------------+\n","|employee_id|    languages|\n","+-----------+-------------+\n","|       8724|[SQL, Python]|\n","|      74430|[SQL, Python]|\n","|      72255|[SQL, Python]|\n","|      38562|[SQL, Python]|\n","|      64486|[SQL, Python]|\n","+-----------+-------------+\n","only showing top 5 rows\n","\n"]}],"source":["#Let's create a new column-languages known for each employee\n","# For simplicity, creating same values for all employees\n","\n","df3=df3.withColumn('languages',F.lit(['SQL','Python']))\n","df3.select('employee_id','languages').show(5)"]},{"cell_type":"code","execution_count":27,"id":"48a3fd03","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:32.245382Z","iopub.status.busy":"2024-06-16T23:26:32.244499Z","iopub.status.idle":"2024-06-16T23:26:32.437886Z","shell.execute_reply":"2024-06-16T23:26:32.436809Z"},"papermill":{"duration":0.226466,"end_time":"2024-06-16T23:26:32.441811","exception":false,"start_time":"2024-06-16T23:26:32.215345","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+------+\n","|employee_id|   col|\n","+-----------+------+\n","|       8724|   SQL|\n","|       8724|Python|\n","|      74430|   SQL|\n","|      74430|Python|\n","|      72255|   SQL|\n","+-----------+------+\n","only showing top 5 rows\n","\n"]}],"source":["df_lang = df3.select(df3.employee_id,F.explode(df3.languages))\n","df_lang.show(5)"]},{"cell_type":"markdown","id":"8fc24514","metadata":{"papermill":{"duration":0.028741,"end_time":"2024-06-16T23:26:32.500733","exception":false,"start_time":"2024-06-16T23:26:32.471992","status":"completed"},"tags":[]},"source":["##### explode can also be used to breakdown a column in dictionary format similar to list. This creates two new columns - key and value"]},{"cell_type":"markdown","id":"cdbcfb99","metadata":{"papermill":{"duration":0.02755,"end_time":"2024-06-16T23:26:32.557543","exception":false,"start_time":"2024-06-16T23:26:32.529993","status":"completed"},"tags":[]},"source":["## udf function\n","\n","##### UDF is User Defined Function that can be used to modify columns or fields"]},{"cell_type":"code","execution_count":28,"id":"cfe5afe1","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:32.605266Z","iopub.status.busy":"2024-06-16T23:26:32.604898Z","iopub.status.idle":"2024-06-16T23:26:32.647488Z","shell.execute_reply":"2024-06-16T23:26:32.646386Z"},"papermill":{"duration":0.065793,"end_time":"2024-06-16T23:26:32.65088","exception":false,"start_time":"2024-06-16T23:26:32.585087","status":"completed"},"tags":[]},"outputs":[],"source":["#udf on one column\n","\n","# Define function\n","def cap_gender(g):\n","    return g.upper()\n","\n","# udf creation\n","gen_udf = F.udf(cap_gender,StringType())\n","\n","# Apply udf\n","df_gen = df3.withColumn('gender_upd',gen_udf(df3.gender))"]},{"cell_type":"code","execution_count":29,"id":"78faa3a9","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:32.695417Z","iopub.status.busy":"2024-06-16T23:26:32.694999Z","iopub.status.idle":"2024-06-16T23:26:34.31548Z","shell.execute_reply":"2024-06-16T23:26:34.314434Z"},"papermill":{"duration":1.646875,"end_time":"2024-06-16T23:26:34.321947","exception":false,"start_time":"2024-06-16T23:26:32.675072","status":"completed"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["[Stage 31:>                                                         (0 + 1) / 1]\r"]},{"name":"stdout","output_type":"stream","text":["+------+----------+\n","|gender|gender_upd|\n","+------+----------+\n","|     m|         M|\n","|     f|         F|\n","|     m|         M|\n","+------+----------+\n","only showing top 3 rows\n","\n"]},{"name":"stderr","output_type":"stream","text":["                                                                                \r"]}],"source":["df_gen.select('gender','gender_upd').show(3)"]},{"cell_type":"markdown","id":"1a149a36","metadata":{"papermill":{"duration":0.029231,"end_time":"2024-06-16T23:26:34.385976","exception":false,"start_time":"2024-06-16T23:26:34.356745","status":"completed"},"tags":[]},"source":["##### UDF with multiple returntypes"]},{"cell_type":"code","execution_count":30,"id":"0e30445b","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:34.444646Z","iopub.status.busy":"2024-06-16T23:26:34.444143Z","iopub.status.idle":"2024-06-16T23:26:34.450328Z","shell.execute_reply":"2024-06-16T23:26:34.44937Z"},"papermill":{"duration":0.038645,"end_time":"2024-06-16T23:26:34.45283","exception":false,"start_time":"2024-06-16T23:26:34.414185","status":"completed"},"tags":[]},"outputs":[],"source":["def modify_dataframe(department,recruitment_channel):\n","    mod_dept = department.upper()\n","    mod_rec_channel = recruitment_channel.title()\n","    return mod_dept,mod_rec_channel"]},{"cell_type":"code","execution_count":31,"id":"c15458e3","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:34.512747Z","iopub.status.busy":"2024-06-16T23:26:34.511888Z","iopub.status.idle":"2024-06-16T23:26:34.518209Z","shell.execute_reply":"2024-06-16T23:26:34.517189Z"},"papermill":{"duration":0.039873,"end_time":"2024-06-16T23:26:34.520645","exception":false,"start_time":"2024-06-16T23:26:34.480772","status":"completed"},"tags":[]},"outputs":[],"source":["#Register UDF\n","df_udf = F.udf(modify_dataframe,StructType([StructField('mod_dept',StringType()),\n","                                           StructField('mode_rec_channel',StringType())]))"]},{"cell_type":"code","execution_count":32,"id":"90e27720","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:34.579146Z","iopub.status.busy":"2024-06-16T23:26:34.578764Z","iopub.status.idle":"2024-06-16T23:26:34.733461Z","shell.execute_reply":"2024-06-16T23:26:34.732546Z"},"papermill":{"duration":0.186373,"end_time":"2024-06-16T23:26:34.735903","exception":false,"start_time":"2024-06-16T23:26:34.54953","status":"completed"},"tags":[]},"outputs":[],"source":["#Apply udf to dataframe\n","df4 = df3.withColumn('mod_columns',df_udf(df3['department'],df3['recruitment_channel']))"]},{"cell_type":"code","execution_count":33,"id":"50647615","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:34.774537Z","iopub.status.busy":"2024-06-16T23:26:34.773713Z","iopub.status.idle":"2024-06-16T23:26:35.09391Z","shell.execute_reply":"2024-06-16T23:26:35.092782Z"},"papermill":{"duration":0.342808,"end_time":"2024-06-16T23:26:35.097107","exception":false,"start_time":"2024-06-16T23:26:34.754299","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+--------------------+\n","|         mod_columns|\n","+--------------------+\n","|{TECHNOLOGY, Sour...|\n","|         {HR, Other}|\n","|{SALES & MARKETIN...|\n","|{PROCUREMENT, Other}|\n","+--------------------+\n","only showing top 4 rows\n","\n"]}],"source":["df4.select('mod_columns').show(4)"]},{"cell_type":"code","execution_count":34,"id":"5a02e7ad","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:26:35.148297Z","iopub.status.busy":"2024-06-16T23:26:35.147656Z","iopub.status.idle":"2024-06-16T23:26:35.515868Z","shell.execute_reply":"2024-06-16T23:26:35.514777Z"},"papermill":{"duration":0.393931,"end_time":"2024-06-16T23:26:35.519154","exception":false,"start_time":"2024-06-16T23:26:35.125223","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------------+----------------+\n","|         mod_dept|mode_rec_channel|\n","+-----------------+----------------+\n","|       TECHNOLOGY|        Sourcing|\n","|               HR|           Other|\n","|SALES & MARKETING|           Other|\n","|      PROCUREMENT|           Other|\n","+-----------------+----------------+\n","only showing top 4 rows\n","\n"]}],"source":["#Split the udf updated columns\n","df5=df4.select('mod_columns.*').drop('mod_columns')\n","df5.show(4)"]},{"cell_type":"code","execution_count":null,"id":"08391e62","metadata":{"papermill":{"duration":0.027179,"end_time":"2024-06-16T23:26:35.576267","exception":false,"start_time":"2024-06-16T23:26:35.549088","status":"completed"},"tags":[]},"outputs":[],"source":[]}],"metadata":{"kaggle":{"accelerator":"none","dataSources":[{"datasetId":3537629,"sourceId":6165969,"sourceType":"datasetVersion"}],"isGpuEnabled":false,"isInternetEnabled":true,"language":"python","sourceType":"notebook"},"kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.10.13"},"papermill":{"default_parameters":{},"duration":79.348771,"end_time":"2024-06-16T23:26:38.216787","environment_variables":{},"exception":null,"input_path":"__notebook__.ipynb","output_path":"__notebook__.ipynb","parameters":{},"start_time":"2024-06-16T23:25:18.868016","version":"2.5.0"}},"nbformat":4,"nbformat_minor":5}