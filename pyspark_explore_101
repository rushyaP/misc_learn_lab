{"cells":[{"source":"<a href=\"https://www.kaggle.com/code/rputtam/pyspark-explore?scriptVersionId=183885579\" target=\"_blank\"><img align=\"left\" alt=\"Kaggle\" title=\"Open in Kaggle\" src=\"https://kaggle.com/static/images/open-in-kaggle.svg\"></a>","metadata":{},"cell_type":"markdown"},{"cell_type":"markdown","id":"e37143cb","metadata":{"papermill":{"duration":0.010483,"end_time":"2024-06-16T23:31:04.018693","exception":false,"start_time":"2024-06-16T23:31:04.00821","status":"completed"},"tags":[]},"source":["## This notebook aims to utilize pyspark and explore various functions for data analysis and manipulation."]},{"cell_type":"markdown","id":"ff1e71e0","metadata":{"papermill":{"duration":0.009794,"end_time":"2024-06-16T23:31:04.039013","exception":false,"start_time":"2024-06-16T23:31:04.029219","status":"completed"},"tags":[]},"source":["Resources for pySpark \n","1. https://sparkbyexamples.com/pyspark-tutorial/\n","2. https://github.com/spark-examples/pyspark-examples\n","3. https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/functions.html?hl=en-GB"]},{"cell_type":"markdown","id":"8eca8dc5","metadata":{"papermill":{"duration":0.010474,"end_time":"2024-06-16T23:31:04.059567","exception":false,"start_time":"2024-06-16T23:31:04.049093","status":"completed"},"tags":[]},"source":["##### There are two types of pyspark rdd operations - transformations and actions\n","* Transformations return rdds\n","* Actions return the result (non-rdds)"]},{"cell_type":"code","execution_count":1,"id":"413fd956","metadata":{"_cell_guid":"b1076dfc-b9ad-4769-8c92-a6c4dae69d19","_uuid":"8f2839f25d086af736a60e9eeb907d3b93b6e0e5","execution":{"iopub.execute_input":"2024-06-16T23:31:04.083928Z","iopub.status.busy":"2024-06-16T23:31:04.083543Z","iopub.status.idle":"2024-06-16T23:31:05.046644Z","shell.execute_reply":"2024-06-16T23:31:05.045045Z"},"papermill":{"duration":0.97825,"end_time":"2024-06-16T23:31:05.049557","exception":false,"start_time":"2024-06-16T23:31:04.071307","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["/kaggle/input/employees-performance-for-hr-analytics/Uncleaned_employees_final_dataset (1).csv\n"]}],"source":["# This Python 3 environment comes with many helpful analytics libraries installed\n","# It is defined by the kaggle/python Docker image: https://github.com/kaggle/docker-python\n","# For example, here's several helpful packages to load\n","\n","import numpy as np # linear algebra\n","import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\n","\n","# Input data files are available in the read-only \"../input/\" directory\n","# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n","\n","import os\n","for dirname, _, filenames in os.walk('/kaggle/input'):\n","    for filename in filenames:\n","        print(os.path.join(dirname, filename))\n","\n","# You can write up to 20GB to the current directory (/kaggle/working/) that gets preserved as output when you create a version using \"Save & Run All\" \n","# You can also write temporary files to /kaggle/temp/, but they won't be saved outside of the current session"]},{"cell_type":"markdown","id":"ae09ac3e","metadata":{"papermill":{"duration":0.010659,"end_time":"2024-06-16T23:31:05.071058","exception":false,"start_time":"2024-06-16T23:31:05.060399","status":"completed"},"tags":[]},"source":["## Install PySpark"]},{"cell_type":"code","execution_count":2,"id":"c8491a82","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:31:05.094025Z","iopub.status.busy":"2024-06-16T23:31:05.093539Z","iopub.status.idle":"2024-06-16T23:31:56.79189Z","shell.execute_reply":"2024-06-16T23:31:56.790459Z"},"papermill":{"duration":51.713569,"end_time":"2024-06-16T23:31:56.795104","exception":false,"start_time":"2024-06-16T23:31:05.081535","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["Collecting pyspark\r\n","  Downloading pyspark-3.5.1.tar.gz (317.0 MB)\r\n","\u001b[2K     \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m317.0/317.0 MB\u001b[0m \u001b[31m4.6 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\r\n","\u001b[?25h  Preparing metadata (setup.py) ... \u001b[?25l-\b \b\\\b \bdone\r\n","\u001b[?25hRequirement already satisfied: py4j==0.10.9.7 in /opt/conda/lib/python3.10/site-packages (from pyspark) (0.10.9.7)\r\n","Building wheels for collected packages: pyspark\r\n","  Building wheel for pyspark (setup.py) ... \u001b[?25l-\b \b\\\b \b|\b \bdone\r\n","\u001b[?25h  Created wheel for pyspark: filename=pyspark-3.5.1-py2.py3-none-any.whl size=317488493 sha256=fd1e55b608f30d634721f87861442baaea91a46da86135d9e9f864372e7de660\r\n","  Stored in directory: /root/.cache/pip/wheels/80/1d/60/2c256ed38dddce2fdd93be545214a63e02fbd8d74fb0b7f3a6\r\n","Successfully built pyspark\r\n","Installing collected packages: pyspark\r\n","Successfully installed pyspark-3.5.1\r\n"]}],"source":["# Installing Pyspark\n","!pip install pyspark"]},{"cell_type":"markdown","id":"befeb270","metadata":{"papermill":{"duration":0.016535,"end_time":"2024-06-16T23:31:56.829182","exception":false,"start_time":"2024-06-16T23:31:56.812647","status":"completed"},"tags":[]},"source":["## Create SparkSession"]},{"cell_type":"code","execution_count":3,"id":"e653671d","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:31:56.864809Z","iopub.status.busy":"2024-06-16T23:31:56.864377Z","iopub.status.idle":"2024-06-16T23:32:03.593844Z","shell.execute_reply":"2024-06-16T23:32:03.592217Z"},"papermill":{"duration":6.75136,"end_time":"2024-06-16T23:32:03.597308","exception":false,"start_time":"2024-06-16T23:31:56.845948","status":"completed"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["Setting default log level to \"WARN\".\n","To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).\n","24/06/16 23:32:01 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable\n"]}],"source":["# Importing and creating SparkSession\n","from pyspark.sql import SparkSession\n","spark = SparkSession.builder.appName('explore_pyspark').getOrCreate()"]},{"cell_type":"code","execution_count":4,"id":"2d1b99ab","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:03.642757Z","iopub.status.busy":"2024-06-16T23:32:03.641562Z","iopub.status.idle":"2024-06-16T23:32:03.648581Z","shell.execute_reply":"2024-06-16T23:32:03.64745Z"},"papermill":{"duration":0.032139,"end_time":"2024-06-16T23:32:03.651117","exception":false,"start_time":"2024-06-16T23:32:03.618978","status":"completed"},"tags":[]},"outputs":[],"source":["# Importing necessary packages\n","from pyspark.sql.types import *\n","#from pyspark.sql.functions import *\n","import pyspark.sql.functions as F"]},{"cell_type":"markdown","id":"76ac4e04","metadata":{"papermill":{"duration":0.020553,"end_time":"2024-06-16T23:32:03.691554","exception":false,"start_time":"2024-06-16T23:32:03.671001","status":"completed"},"tags":[]},"source":["## Loading data"]},{"cell_type":"code","execution_count":5,"id":"7ad5fc7d","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:03.728195Z","iopub.status.busy":"2024-06-16T23:32:03.727776Z","iopub.status.idle":"2024-06-16T23:32:12.599078Z","shell.execute_reply":"2024-06-16T23:32:12.597821Z"},"papermill":{"duration":8.893377,"end_time":"2024-06-16T23:32:12.602729","exception":false,"start_time":"2024-06-16T23:32:03.709352","status":"completed"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["                                                                                \r"]},{"name":"stdout","output_type":"stream","text":["root\n"," |-- employee_id: string (nullable = true)\n"," |-- department: string (nullable = true)\n"," |-- region: string (nullable = true)\n"," |-- education: string (nullable = true)\n"," |-- gender: string (nullable = true)\n"," |-- recruitment_channel: string (nullable = true)\n"," |-- no_of_trainings: string (nullable = true)\n"," |-- age: string (nullable = true)\n"," |-- previous_year_rating: string (nullable = true)\n"," |-- length_of_service: string (nullable = true)\n"," |-- KPIs_met_more_than_80: string (nullable = true)\n"," |-- awards_won: string (nullable = true)\n"," |-- avg_training_score: string (nullable = true)\n","\n"]}],"source":["# Reading the kaggle dataset without inferschema\n","df = spark.read.csv('/kaggle/input/employees-performance-for-hr-analytics/Uncleaned_employees_final_dataset (1).csv',header=True)\n","df.printSchema()"]},{"cell_type":"code","execution_count":6,"id":"8fd8fe9e","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:12.657417Z","iopub.status.busy":"2024-06-16T23:32:12.656904Z","iopub.status.idle":"2024-06-16T23:32:14.219271Z","shell.execute_reply":"2024-06-16T23:32:14.217528Z"},"papermill":{"duration":1.603826,"end_time":"2024-06-16T23:32:14.23424","exception":false,"start_time":"2024-06-16T23:32:12.630414","status":"completed"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["[Stage 2:>                                                          (0 + 1) / 1]\r"]},{"name":"stdout","output_type":"stream","text":["root\n"," |-- employee_id: integer (nullable = true)\n"," |-- department: string (nullable = true)\n"," |-- region: string (nullable = true)\n"," |-- education: string (nullable = true)\n"," |-- gender: string (nullable = true)\n"," |-- recruitment_channel: string (nullable = true)\n"," |-- no_of_trainings: integer (nullable = true)\n"," |-- age: integer (nullable = true)\n"," |-- previous_year_rating: integer (nullable = true)\n"," |-- length_of_service: integer (nullable = true)\n"," |-- KPIs_met_more_than_80: integer (nullable = true)\n"," |-- awards_won: integer (nullable = true)\n"," |-- avg_training_score: integer (nullable = true)\n","\n"]},{"name":"stderr","output_type":"stream","text":["                                                                                \r"]}],"source":["# Reading the kaggle dataset with inferschema and checking the data types\n","df = spark.read.csv('/kaggle/input/employees-performance-for-hr-analytics/Uncleaned_employees_final_dataset (1).csv',inferSchema= True,header=True)\n","#inferSchema infers the datatype of field from its values. But it reads the entire data and may have performance issues while reading larger datasets.\n","#The otherway is to predefine the schema using structType that saves time - Optimized approach\n","df.printSchema()"]},{"cell_type":"code","execution_count":7,"id":"eb7f3b2c","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:14.304461Z","iopub.status.busy":"2024-06-16T23:32:14.303929Z","iopub.status.idle":"2024-06-16T23:32:14.313405Z","shell.execute_reply":"2024-06-16T23:32:14.31252Z"},"papermill":{"duration":0.045215,"end_time":"2024-06-16T23:32:14.317809","exception":false,"start_time":"2024-06-16T23:32:14.272594","status":"completed"},"tags":[]},"outputs":[],"source":["#Pre-defining the schmea\n","# Note, all the fields available in the data need to be defined, the size of the structType and dataframe should match\n","\n","sch = StructType([\n","    StructField(\"employee_id\",IntegerType(),True),\n","    StructField(\"department\",StringType(),True),\n","    StructField(\"region\",StringType(),True),\n","    StructField(\"education\",StringType(),True),\n","    StructField(\"gender\",StringType(),True),\n","    StructField(\"recruitment_channel\",StringType(),True),\n","    StructField(\"no_of_trainings\",IntegerType(),True),\n","    StructField(\"age\",IntegerType(),True),\n","    StructField(\"previous_year_rating\",IntegerType(),True),\n","    StructField(\"length_of_service\",IntegerType(),True),\n","    StructField(\"KPIs_met_more_than_80\",IntegerType(),True),\n","    StructField(\"awards_won\",IntegerType(),True),\n","    StructField(\"avg_training_score\",IntegerType(),True)\n","])"]},{"cell_type":"code","execution_count":8,"id":"c4b24b65","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:14.37163Z","iopub.status.busy":"2024-06-16T23:32:14.371214Z","iopub.status.idle":"2024-06-16T23:32:14.458273Z","shell.execute_reply":"2024-06-16T23:32:14.457197Z"},"papermill":{"duration":0.113347,"end_time":"2024-06-16T23:32:14.462297","exception":false,"start_time":"2024-06-16T23:32:14.34895","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["root\n"," |-- employee_id: integer (nullable = true)\n"," |-- department: string (nullable = true)\n"," |-- region: string (nullable = true)\n"," |-- education: string (nullable = true)\n"," |-- gender: string (nullable = true)\n"," |-- recruitment_channel: string (nullable = true)\n"," |-- no_of_trainings: integer (nullable = true)\n"," |-- age: integer (nullable = true)\n"," |-- previous_year_rating: integer (nullable = true)\n"," |-- length_of_service: integer (nullable = true)\n"," |-- KPIs_met_more_than_80: integer (nullable = true)\n"," |-- awards_won: integer (nullable = true)\n"," |-- avg_training_score: integer (nullable = true)\n","\n"]}],"source":["df3 = spark.read\\\n",".option(\"header\",True) \\\n",".schema(sch) \\\n",".csv('/kaggle/input/employees-performance-for-hr-analytics/Uncleaned_employees_final_dataset (1).csv')\n","\n","df3.printSchema()"]},{"cell_type":"markdown","id":"200f0c66","metadata":{"papermill":{"duration":0.021298,"end_time":"2024-06-16T23:32:14.506537","exception":false,"start_time":"2024-06-16T23:32:14.485239","status":"completed"},"tags":[]},"source":["## withColumn()"]},{"cell_type":"markdown","id":"27d432f4","metadata":{"papermill":{"duration":0.018697,"end_time":"2024-06-16T23:32:14.546296","exception":false,"start_time":"2024-06-16T23:32:14.527599","status":"completed"},"tags":[]},"source":["### .lit()"]},{"cell_type":"code","execution_count":9,"id":"460928e8","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:14.584453Z","iopub.status.busy":"2024-06-16T23:32:14.583407Z","iopub.status.idle":"2024-06-16T23:32:15.086588Z","shell.execute_reply":"2024-06-16T23:32:15.084899Z"},"papermill":{"duration":0.526632,"end_time":"2024-06-16T23:32:15.090268","exception":false,"start_time":"2024-06-16T23:32:14.563636","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+-------+-------+\n","|employee_id|company|country|\n","+-----------+-------+-------+\n","|       8724|    ABC|    USA|\n","|      74430|    ABC|    USA|\n","+-----------+-------+-------+\n","only showing top 2 rows\n","\n"]}],"source":["# Creating new column with constant value\n","df2 = df.withColumn(\"company\",F.lit('ABC'))\\\n","        .withColumn(\"country\", F.lit('USA'))\n","df2.select('employee_id','company','country').show(2)"]},{"cell_type":"code","execution_count":10,"id":"7b9b843b","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:15.148629Z","iopub.status.busy":"2024-06-16T23:32:15.148151Z","iopub.status.idle":"2024-06-16T23:32:15.312833Z","shell.execute_reply":"2024-06-16T23:32:15.310893Z"},"papermill":{"duration":0.197066,"end_time":"2024-06-16T23:32:15.316476","exception":false,"start_time":"2024-06-16T23:32:15.11941","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["root\n"," |-- employee_id: integer (nullable = true)\n"," |-- department: string (nullable = true)\n"," |-- region: string (nullable = true)\n"," |-- education: string (nullable = true)\n"," |-- gender: string (nullable = true)\n"," |-- recruitment_channel: string (nullable = true)\n"," |-- no_of_trainings: integer (nullable = true)\n"," |-- age: integer (nullable = true)\n"," |-- previous_year_rating: integer (nullable = true)\n"," |-- length_of_service: integer (nullable = true)\n"," |-- KPIs_met_more_than_80: integer (nullable = true)\n"," |-- awards_won: integer (nullable = true)\n"," |-- avg_training_score: integer (nullable = true)\n","\n"]}],"source":["# Changing column datatypes of selected fields using withColumn\n","\n","df2 = df.withColumn(\"age\",df.age.cast(IntegerType())) \\\n",".withColumn(\"length_of_service\",df.length_of_service.cast(IntegerType()))\n","df2.printSchema()"]},{"cell_type":"code","execution_count":11,"id":"3d97e817","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:15.364606Z","iopub.status.busy":"2024-06-16T23:32:15.364201Z","iopub.status.idle":"2024-06-16T23:32:15.391104Z","shell.execute_reply":"2024-06-16T23:32:15.389661Z"},"papermill":{"duration":0.055018,"end_time":"2024-06-16T23:32:15.398309","exception":false,"start_time":"2024-06-16T23:32:15.343291","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["root\n"," |-- employee_id: integer (nullable = true)\n"," |-- department: string (nullable = true)\n"," |-- region: string (nullable = true)\n"," |-- education: string (nullable = true)\n"," |-- gender: string (nullable = true)\n"," |-- recruitment_channel: string (nullable = true)\n"," |-- no_of_trainings: integer (nullable = true)\n"," |-- age: integer (nullable = true)\n"," |-- previous_year_rating: integer (nullable = true)\n"," |-- length_of_service: integer (nullable = true)\n"," |-- KPIs_met_more_than_80: integer (nullable = true)\n"," |-- awards_won: integer (nullable = true)\n"," |-- avg_training_score: integer (nullable = true)\n","\n"]}],"source":["# Rename column\n","df2 = df2.withColumnsRenamed({'country':'nation','company':'org'})\n","df2.printSchema()"]},{"cell_type":"code","execution_count":12,"id":"a20d2580","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:15.456097Z","iopub.status.busy":"2024-06-16T23:32:15.455595Z","iopub.status.idle":"2024-06-16T23:32:15.483334Z","shell.execute_reply":"2024-06-16T23:32:15.482163Z"},"papermill":{"duration":0.059436,"end_time":"2024-06-16T23:32:15.488859","exception":false,"start_time":"2024-06-16T23:32:15.429423","status":"completed"},"tags":[]},"outputs":[{"data":{"text/plain":["['employee_id',\n"," 'department',\n"," 'region',\n"," 'education',\n"," 'gender',\n"," 'recruitment_channel',\n"," 'no_of_trainings',\n"," 'age',\n"," 'previous_year_rating',\n"," 'length_of_service',\n"," 'KPIs_met_more_than_80',\n"," 'awards_won',\n"," 'avg_training_score']"]},"execution_count":12,"metadata":{},"output_type":"execute_result"}],"source":["df2=df2.drop(\"org\",\"nation\")\n","df2.columns"]},{"cell_type":"markdown","id":"bbd8370a","metadata":{"papermill":{"duration":0.020258,"end_time":"2024-06-16T23:32:15.555671","exception":false,"start_time":"2024-06-16T23:32:15.535413","status":"completed"},"tags":[]},"source":["## .select()"]},{"cell_type":"code","execution_count":13,"id":"d8b0a512","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:15.600397Z","iopub.status.busy":"2024-06-16T23:32:15.598783Z","iopub.status.idle":"2024-06-16T23:32:15.917246Z","shell.execute_reply":"2024-06-16T23:32:15.915938Z"},"papermill":{"duration":0.343881,"end_time":"2024-06-16T23:32:15.920615","exception":false,"start_time":"2024-06-16T23:32:15.576734","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["<class 'pyspark.sql.dataframe.DataFrame'>\n","+-----------+---+\n","|employee_id|age|\n","+-----------+---+\n","|       8724| 24|\n","|      74430| 31|\n","|      72255| 31|\n","|      38562| 31|\n","|      64486| 30|\n","+-----------+---+\n","only showing top 5 rows\n","\n"]}],"source":["# selecting few fields using select\n","x = df3.select('employee_id','age')\n","print(type(x))\n","x.show(5)"]},{"cell_type":"markdown","id":"76d48b6b","metadata":{"papermill":{"duration":0.02912,"end_time":"2024-06-16T23:32:16.059999","exception":false,"start_time":"2024-06-16T23:32:16.030879","status":"completed"},"tags":[]},"source":["## .filter()"]},{"cell_type":"code","execution_count":14,"id":"66f439ef","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:16.106621Z","iopub.status.busy":"2024-06-16T23:32:16.106207Z","iopub.status.idle":"2024-06-16T23:32:16.4568Z","shell.execute_reply":"2024-06-16T23:32:16.455001Z"},"papermill":{"duration":0.390291,"end_time":"2024-06-16T23:32:16.47291","exception":false,"start_time":"2024-06-16T23:32:16.082619","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+---+\n","|employee_id|age|\n","+-----------+---+\n","|       8724| 24|\n","|      74430| 31|\n","|      72255| 31|\n","|      38562| 31|\n","|      64486| 30|\n","+-----------+---+\n","only showing top 5 rows\n","\n"]}],"source":["#filter with one condition\n","df3.filter(df3.age > 20).select('employee_id','age').show(5)"]},{"cell_type":"code","execution_count":15,"id":"297df031","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:16.566917Z","iopub.status.busy":"2024-06-16T23:32:16.564283Z","iopub.status.idle":"2024-06-16T23:32:17.120317Z","shell.execute_reply":"2024-06-16T23:32:17.118553Z"},"papermill":{"duration":0.607628,"end_time":"2024-06-16T23:32:17.127773","exception":false,"start_time":"2024-06-16T23:32:16.520145","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+----------+---+\n","|employee_id|department|age|\n","+-----------+----------+---+\n","|      74430|        HR| 31|\n","|      10761|        HR| 58|\n","|      50038|        HR| 33|\n","|      50380|        HR| 31|\n","+-----------+----------+---+\n","only showing top 4 rows\n","\n"]}],"source":["#Filter with multiple conditions\n","df3.filter( (df3.age >20) & (df3.department == \"HR\") ).select('employee_id',\n","                                                              'department',\n","                                                              'age').show(4)"]},{"cell_type":"code","execution_count":16,"id":"01638c48","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:17.202583Z","iopub.status.busy":"2024-06-16T23:32:17.202124Z","iopub.status.idle":"2024-06-16T23:32:17.23958Z","shell.execute_reply":"2024-06-16T23:32:17.238281Z"},"papermill":{"duration":0.075133,"end_time":"2024-06-16T23:32:17.243274","exception":false,"start_time":"2024-06-16T23:32:17.168141","status":"completed"},"tags":[]},"outputs":[],"source":["# Finance and age>40 or HR \n","df4 = df3.filter( ( (df3.department == \"Finance\") & (df3.age>40) ) | (df3.department == \"HR\") )\\\n","        .select('employee_id','department','age')"]},{"cell_type":"code","execution_count":17,"id":"a511c3c7","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:17.289461Z","iopub.status.busy":"2024-06-16T23:32:17.288469Z","iopub.status.idle":"2024-06-16T23:32:19.131033Z","shell.execute_reply":"2024-06-16T23:32:19.129936Z"},"papermill":{"duration":1.897878,"end_time":"2024-06-16T23:32:19.161683","exception":false,"start_time":"2024-06-16T23:32:17.263805","status":"completed"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["[Stage 7:>                                                          (0 + 1) / 1]\r"]},{"name":"stdout","output_type":"stream","text":["+----------+-----+\n","|department|count|\n","+----------+-----+\n","|        HR|  833|\n","|   Finance|   78|\n","+----------+-----+\n","\n"]},{"name":"stderr","output_type":"stream","text":["                                                                                \r"]}],"source":["df4.groupBy('department')\\\n",".count()\\\n",".show()"]},{"cell_type":"code","execution_count":18,"id":"1986f523","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:19.227719Z","iopub.status.busy":"2024-06-16T23:32:19.227216Z","iopub.status.idle":"2024-06-16T23:32:19.641704Z","shell.execute_reply":"2024-06-16T23:32:19.640314Z"},"papermill":{"duration":0.451907,"end_time":"2024-06-16T23:32:19.644922","exception":false,"start_time":"2024-06-16T23:32:19.193015","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+----------+---+\n","|employee_id|department|age|\n","+-----------+----------+---+\n","+-----------+----------+---+\n","\n"]}],"source":["df4.filter((df4.department==\"Finance\") & (df4.age<40)).show()"]},{"cell_type":"markdown","id":"15bf39c9","metadata":{"papermill":{"duration":0.042031,"end_time":"2024-06-16T23:32:19.717867","exception":false,"start_time":"2024-06-16T23:32:19.675836","status":"completed"},"tags":[]},"source":["### Get unique values for categorical fields"]},{"cell_type":"code","execution_count":19,"id":"d3237e74","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:19.774579Z","iopub.status.busy":"2024-06-16T23:32:19.774084Z","iopub.status.idle":"2024-06-16T23:32:20.791322Z","shell.execute_reply":"2024-06-16T23:32:20.790183Z"},"papermill":{"duration":1.047895,"end_time":"2024-06-16T23:32:20.794746","exception":false,"start_time":"2024-06-16T23:32:19.746851","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------------+\n","|       department|\n","+-----------------+\n","|               HR|\n","|          Finance|\n","|        Analytics|\n","|            Legal|\n","|Sales & Marketing|\n","|       Technology|\n","|      Procurement|\n","|       Operations|\n","|              R&D|\n","+-----------------+\n","\n"]}],"source":["df3.select('department')\\\n",".distinct().show()"]},{"cell_type":"code","execution_count":20,"id":"d7551cb2","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:20.868763Z","iopub.status.busy":"2024-06-16T23:32:20.867591Z","iopub.status.idle":"2024-06-16T23:32:21.546559Z","shell.execute_reply":"2024-06-16T23:32:21.545136Z"},"papermill":{"duration":0.716512,"end_time":"2024-06-16T23:32:21.550012","exception":false,"start_time":"2024-06-16T23:32:20.8335","status":"completed"},"tags":[]},"outputs":[{"data":{"text/plain":["['Finance',\n"," 'Legal',\n"," 'Sales & Marketing',\n"," 'HR',\n"," 'Operations',\n"," 'R&D',\n"," 'Analytics',\n"," 'Technology',\n"," 'Procurement']"]},"execution_count":20,"metadata":{},"output_type":"execute_result"}],"source":["# to get unique values as a list\n","df3.agg(F.collect_set(\"department\")).collect()[0][0]"]},{"cell_type":"code","execution_count":21,"id":"b83291aa","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:21.616048Z","iopub.status.busy":"2024-06-16T23:32:21.61451Z","iopub.status.idle":"2024-06-16T23:32:22.091903Z","shell.execute_reply":"2024-06-16T23:32:22.090791Z"},"papermill":{"duration":0.51283,"end_time":"2024-06-16T23:32:22.095154","exception":false,"start_time":"2024-06-16T23:32:21.582324","status":"completed"},"tags":[]},"outputs":[{"data":{"text/plain":["['other', 'referred', 'sourcing']"]},"execution_count":21,"metadata":{},"output_type":"execute_result"}],"source":["df3.agg(F.collect_set(\"recruitment_channel\")).collect()[0][0]"]},{"cell_type":"code","execution_count":22,"id":"1ec69090","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:22.16594Z","iopub.status.busy":"2024-06-16T23:32:22.164742Z","iopub.status.idle":"2024-06-16T23:32:22.808781Z","shell.execute_reply":"2024-06-16T23:32:22.807659Z"},"papermill":{"duration":0.686652,"end_time":"2024-06-16T23:32:22.814114","exception":false,"start_time":"2024-06-16T23:32:22.127462","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+----------+\n","|department|\n","+----------+\n","| Analytics|\n","|Technology|\n","|       R&D|\n","+----------+\n","\n"]}],"source":["dept =['R&D','Technology','Analytics']\n","df4=df3.filter(df3.department.isin(dept))\n","df4.select(df4.department).distinct().show()"]},{"cell_type":"code","execution_count":23,"id":"fb354fcc","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:22.997197Z","iopub.status.busy":"2024-06-16T23:32:22.99654Z","iopub.status.idle":"2024-06-16T23:32:23.005814Z","shell.execute_reply":"2024-06-16T23:32:23.004414Z"},"papermill":{"duration":0.123232,"end_time":"2024-06-16T23:32:23.037223","exception":false,"start_time":"2024-06-16T23:32:22.913991","status":"completed"},"tags":[]},"outputs":[{"data":{"text/plain":["['employee_id',\n"," 'department',\n"," 'region',\n"," 'education',\n"," 'gender',\n"," 'recruitment_channel',\n"," 'no_of_trainings',\n"," 'age',\n"," 'previous_year_rating',\n"," 'length_of_service',\n"," 'KPIs_met_more_than_80',\n"," 'awards_won',\n"," 'avg_training_score']"]},"execution_count":23,"metadata":{},"output_type":"execute_result"}],"source":["df3.columns"]},{"cell_type":"markdown","id":"473b4352","metadata":{"papermill":{"duration":0.030837,"end_time":"2024-06-16T23:32:23.100917","exception":false,"start_time":"2024-06-16T23:32:23.07008","status":"completed"},"tags":[]},"source":["## Aggregate functions"]},{"cell_type":"code","execution_count":24,"id":"bba18f1b","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:23.198659Z","iopub.status.busy":"2024-06-16T23:32:23.198134Z","iopub.status.idle":"2024-06-16T23:32:24.309016Z","shell.execute_reply":"2024-06-16T23:32:24.307861Z"},"papermill":{"duration":1.166994,"end_time":"2024-06-16T23:32:24.317944","exception":false,"start_time":"2024-06-16T23:32:23.15095","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------------+----------+------------------+-------+\n","|       department|median_age|avg_training_score|max_los|\n","+-----------------+----------+------------------+-------+\n","|               HR|      32.0| 50.38775510204081|      2|\n","|          Finance|      31.0| 60.32668329177057|      2|\n","|        Analytics|      31.0| 84.56511490866235|      4|\n","|            Legal|      32.0| 59.53313253012048|      2|\n","|Sales & Marketing|      33.0| 50.05661414437523|      3|\n","|       Technology|      33.0| 79.84765802637563|      4|\n","|      Procurement|      34.5| 70.18035714285715|      4|\n","|       Operations|      35.0|60.351589103291715|      4|\n","|              R&D|      32.0| 84.45180722891567|      2|\n","+-----------------+----------+------------------+-------+\n","\n"]}],"source":["df3.groupBy(['department'])\\\n","   .agg(F.round(F.median('age'),2).alias('median_age'),\n","       F.mean('avg_training_score').alias('avg_training_score'),\n","        F.mode('length_of_service').alias('max_los')\n","       ).show()"]},{"cell_type":"code","execution_count":25,"id":"9cc72e7b","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:24.502844Z","iopub.status.busy":"2024-06-16T23:32:24.502301Z","iopub.status.idle":"2024-06-16T23:32:25.312485Z","shell.execute_reply":"2024-06-16T23:32:25.311226Z"},"papermill":{"duration":0.902317,"end_time":"2024-06-16T23:32:25.315722","exception":false,"start_time":"2024-06-16T23:32:24.413405","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-------------------+----------+------------------+\n","|recruitment_channel|median_age|     trainings_avg|\n","+-------------------+----------+------------------+\n","|              other|      33.0|1.2548456568557071|\n","|           sourcing|      33.0|1.2484691794802014|\n","|           referred|      31.0|1.1766561514195584|\n","+-------------------+----------+------------------+\n","\n"]}],"source":["df3.groupBy(['recruitment_channel'])\\\n","   .agg(F.median('age').alias('median_age'),\n","       F.mean('no_of_trainings').alias('trainings_avg'))\\\n","   .show()"]},{"cell_type":"markdown","id":"1ad64c81","metadata":{"papermill":{"duration":0.019713,"end_time":"2024-06-16T23:32:25.360998","exception":false,"start_time":"2024-06-16T23:32:25.341285","status":"completed"},"tags":[]},"source":["## .explode()"]},{"cell_type":"code","execution_count":26,"id":"1f2cc709","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:25.402896Z","iopub.status.busy":"2024-06-16T23:32:25.401792Z","iopub.status.idle":"2024-06-16T23:32:25.670024Z","shell.execute_reply":"2024-06-16T23:32:25.668506Z"},"papermill":{"duration":0.292937,"end_time":"2024-06-16T23:32:25.673637","exception":false,"start_time":"2024-06-16T23:32:25.3807","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+-------------+\n","|employee_id|    languages|\n","+-----------+-------------+\n","|       8724|[SQL, Python]|\n","|      74430|[SQL, Python]|\n","|      72255|[SQL, Python]|\n","|      38562|[SQL, Python]|\n","|      64486|[SQL, Python]|\n","+-----------+-------------+\n","only showing top 5 rows\n","\n"]}],"source":["#Let's create a new column-languages known for each employee\n","# For simplicity, creating same values for all employees\n","\n","df3=df3.withColumn('languages',F.lit(['SQL','Python']))\n","df3.select('employee_id','languages').show(5)"]},{"cell_type":"code","execution_count":27,"id":"55284b5f","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:25.73935Z","iopub.status.busy":"2024-06-16T23:32:25.738803Z","iopub.status.idle":"2024-06-16T23:32:26.155376Z","shell.execute_reply":"2024-06-16T23:32:26.154269Z"},"papermill":{"duration":0.452718,"end_time":"2024-06-16T23:32:26.158549","exception":false,"start_time":"2024-06-16T23:32:25.705831","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------+------+\n","|employee_id|   col|\n","+-----------+------+\n","|       8724|   SQL|\n","|       8724|Python|\n","|      74430|   SQL|\n","|      74430|Python|\n","|      72255|   SQL|\n","+-----------+------+\n","only showing top 5 rows\n","\n"]}],"source":["df_lang = df3.select(df3.employee_id,F.explode(df3.languages))\n","df_lang.show(5)"]},{"cell_type":"markdown","id":"4d46e390","metadata":{"papermill":{"duration":0.032466,"end_time":"2024-06-16T23:32:26.222046","exception":false,"start_time":"2024-06-16T23:32:26.18958","status":"completed"},"tags":[]},"source":["##### explode can also be used to breakdown a column in dictionary format similar to list. This creates two new columns - key and value"]},{"cell_type":"markdown","id":"3b14d5aa","metadata":{"papermill":{"duration":0.030887,"end_time":"2024-06-16T23:32:26.286262","exception":false,"start_time":"2024-06-16T23:32:26.255375","status":"completed"},"tags":[]},"source":["## udf function\n","\n","##### UDF is User Defined Function that can be used to modify columns or fields"]},{"cell_type":"code","execution_count":28,"id":"a3b41e99","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:26.351045Z","iopub.status.busy":"2024-06-16T23:32:26.350533Z","iopub.status.idle":"2024-06-16T23:32:26.406111Z","shell.execute_reply":"2024-06-16T23:32:26.404619Z"},"papermill":{"duration":0.093049,"end_time":"2024-06-16T23:32:26.409397","exception":false,"start_time":"2024-06-16T23:32:26.316348","status":"completed"},"tags":[]},"outputs":[],"source":["#udf on one column\n","\n","# Define function\n","def cap_gender(g):\n","    return g.upper()\n","\n","# udf creation\n","gen_udf = F.udf(cap_gender,StringType())\n","\n","# Apply udf\n","df_gen = df3.withColumn('gender_upd',gen_udf(df3.gender))"]},{"cell_type":"code","execution_count":29,"id":"3cef262c","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:26.457978Z","iopub.status.busy":"2024-06-16T23:32:26.457547Z","iopub.status.idle":"2024-06-16T23:32:28.354656Z","shell.execute_reply":"2024-06-16T23:32:28.353499Z"},"papermill":{"duration":1.922412,"end_time":"2024-06-16T23:32:28.359122","exception":false,"start_time":"2024-06-16T23:32:26.43671","status":"completed"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["[Stage 31:>                                                         (0 + 1) / 1]\r"]},{"name":"stdout","output_type":"stream","text":["+------+----------+\n","|gender|gender_upd|\n","+------+----------+\n","|     m|         M|\n","|     f|         F|\n","|     m|         M|\n","+------+----------+\n","only showing top 3 rows\n","\n"]},{"name":"stderr","output_type":"stream","text":["                                                                                \r"]}],"source":["df_gen.select('gender','gender_upd').show(3)"]},{"cell_type":"markdown","id":"ec7b5937","metadata":{"papermill":{"duration":0.029089,"end_time":"2024-06-16T23:32:28.422947","exception":false,"start_time":"2024-06-16T23:32:28.393858","status":"completed"},"tags":[]},"source":["##### UDF with multiple returntypes"]},{"cell_type":"code","execution_count":30,"id":"66d8bda3","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:28.467959Z","iopub.status.busy":"2024-06-16T23:32:28.467559Z","iopub.status.idle":"2024-06-16T23:32:28.472886Z","shell.execute_reply":"2024-06-16T23:32:28.471821Z"},"papermill":{"duration":0.028999,"end_time":"2024-06-16T23:32:28.475355","exception":false,"start_time":"2024-06-16T23:32:28.446356","status":"completed"},"tags":[]},"outputs":[],"source":["def modify_dataframe(department,recruitment_channel):\n","    mod_dept = department.upper()\n","    mod_rec_channel = recruitment_channel.title()\n","    return mod_dept,mod_rec_channel"]},{"cell_type":"code","execution_count":31,"id":"30b19480","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:28.51602Z","iopub.status.busy":"2024-06-16T23:32:28.515639Z","iopub.status.idle":"2024-06-16T23:32:28.521215Z","shell.execute_reply":"2024-06-16T23:32:28.520205Z"},"papermill":{"duration":0.028516,"end_time":"2024-06-16T23:32:28.52339","exception":false,"start_time":"2024-06-16T23:32:28.494874","status":"completed"},"tags":[]},"outputs":[],"source":["#Register UDF\n","df_udf = F.udf(modify_dataframe,StructType([StructField('mod_dept',StringType()),\n","                                           StructField('mode_rec_channel',StringType())]))"]},{"cell_type":"code","execution_count":32,"id":"89e60344","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:28.565537Z","iopub.status.busy":"2024-06-16T23:32:28.565107Z","iopub.status.idle":"2024-06-16T23:32:28.714717Z","shell.execute_reply":"2024-06-16T23:32:28.71352Z"},"papermill":{"duration":0.173494,"end_time":"2024-06-16T23:32:28.717288","exception":false,"start_time":"2024-06-16T23:32:28.543794","status":"completed"},"tags":[]},"outputs":[],"source":["#Apply udf to dataframe\n","df4 = df3.withColumn('mod_columns',df_udf(df3['department'],df3['recruitment_channel']))"]},{"cell_type":"code","execution_count":33,"id":"d37ab4d6","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:28.759413Z","iopub.status.busy":"2024-06-16T23:32:28.759045Z","iopub.status.idle":"2024-06-16T23:32:29.109291Z","shell.execute_reply":"2024-06-16T23:32:29.108082Z"},"papermill":{"duration":0.376266,"end_time":"2024-06-16T23:32:29.113326","exception":false,"start_time":"2024-06-16T23:32:28.73706","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+--------------------+\n","|         mod_columns|\n","+--------------------+\n","|{TECHNOLOGY, Sour...|\n","|         {HR, Other}|\n","|{SALES & MARKETIN...|\n","|{PROCUREMENT, Other}|\n","+--------------------+\n","only showing top 4 rows\n","\n"]}],"source":["df4.select('mod_columns').show(4)"]},{"cell_type":"code","execution_count":34,"id":"b67aeab0","metadata":{"execution":{"iopub.execute_input":"2024-06-16T23:32:29.176504Z","iopub.status.busy":"2024-06-16T23:32:29.17589Z","iopub.status.idle":"2024-06-16T23:32:29.543906Z","shell.execute_reply":"2024-06-16T23:32:29.542675Z"},"papermill":{"duration":0.405069,"end_time":"2024-06-16T23:32:29.549855","exception":false,"start_time":"2024-06-16T23:32:29.144786","status":"completed"},"tags":[]},"outputs":[{"name":"stdout","output_type":"stream","text":["+-----------------+----------------+\n","|         mod_dept|mode_rec_channel|\n","+-----------------+----------------+\n","|       TECHNOLOGY|        Sourcing|\n","|               HR|           Other|\n","|SALES & MARKETING|           Other|\n","|      PROCUREMENT|           Other|\n","+-----------------+----------------+\n","only showing top 4 rows\n","\n"]}],"source":["#Split the udf updated columns\n","df5=df4.select('mod_columns.*').drop('mod_columns')\n","df5.show(4)"]},{"cell_type":"code","execution_count":null,"id":"4c830391","metadata":{"papermill":{"duration":0.031471,"end_time":"2024-06-16T23:32:29.613312","exception":false,"start_time":"2024-06-16T23:32:29.581841","status":"completed"},"tags":[]},"outputs":[],"source":[]}],"metadata":{"kaggle":{"accelerator":"none","dataSources":[{"datasetId":3537629,"sourceId":6165969,"sourceType":"datasetVersion"}],"isGpuEnabled":false,"isInternetEnabled":true,"language":"python","sourceType":"notebook"},"kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.10.13"},"papermill":{"default_parameters":{},"duration":91.205393,"end_time":"2024-06-16T23:32:32.273705","environment_variables":{},"exception":null,"input_path":"__notebook__.ipynb","output_path":"__notebook__.ipynb","parameters":{},"start_time":"2024-06-16T23:31:01.068312","version":"2.5.0"}},"nbformat":4,"nbformat_minor":5}